<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: sans-serif; padding: 10px; position: relative; }
    fieldset { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
    legend { font-weight: bold; }
    label, select, input, button { margin: 6px 0; display: block; width: 100%; }
    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    #loadingOverlay {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      z-index: 1000;
      text-align: center;
      padding-top: 40%;
    }
    #loadingBar {
      width: 80%;
      height: 20px;
    }
    #loadingText {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- 1. ì‘ì—… í˜‘ì˜ ì‹œíŠ¸ ìƒì„± -->
  <fieldset>
    <legend>1. ì‘ì—… í˜‘ì˜ ì‹œíŠ¸ ìƒì„±</legend>
    <label for="sourceSheet1">â‘  ë°ì´í„° ì·¨í•© ì‹œíŠ¸:</label>
    <select id="sourceSheet1"></select>

    <label for="templateSheet1">â‘¡ ë³µì‚¬í•  ì‹œíŠ¸ (ì–‘ì‹ í…œí”Œë¦¿):</label>
    <select id="templateSheet1"></select>

    <label for="date1">â‘¢ ë‚ ì§œ ì„ íƒ:</label>
    <input type="date" id="date1">

    <button id="createBtn" type="button">ìƒì„±</button>
  </fieldset>

  <!-- 2. ë‹¹ì¼ ì‘ì—… í™•ì • -->
  <fieldset>
    <legend>2. ë‹¹ì¼ ì‘ì—… í™•ì •</legend>
    <label for="moveSheet">ì‹œíŠ¸ ì„ íƒ:</label>
    <select id="moveSheet"></select>

    <button id="moveBtn" type="button">í™•ì •</button>
  </fieldset>

  <!-- 3. ì‹œíŠ¸ ë‚´ë³´ë‚´ê¸° -->
  <fieldset>
    <legend>3. ì‹œíŠ¸ ë‚´ë³´ë‚´ê¸°</legend>
    <label for="sheet1">ì•ˆì‹¬ ì·¨í•© ë¦¬ìŠ¤íŠ¸:</label>
    <select id="sheet1" name="sheetName1"></select>

    <label for="sheet2">ì‘ì—… ì·¨í•© ë¦¬ìŠ¤íŠ¸:</label>
    <select id="sheet2" name="sheetName2"></select>

    <input type="hidden" id="destId" name="destId" value="<?!= destId ?>">
    <button id="exportBtn" type="button">ë‚´ë³´ë‚´ê¸°</button>
  </fieldset>

  <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
  <div id="loadingOverlay">
    <progress id="loadingBar" max="100" value="0"></progress>
    <div id="loadingText">ì§„í–‰ ì¤‘...</div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // ì‹œíŠ¸ ëª©ë¡ ì´ˆê¸°í™”
    google.script.run.withSuccessHandler(pop1).getSheetNames();
    google.script.run.withSuccessHandler(pop2).getSheetNames();
    google.script.run.withSuccessHandler(pop3).getSheetNames();

    // ì˜¤ëŠ˜ ë‚ ì§œ ìë™ ì„¸íŒ…
    const today = new Date(Date.now() - new Date().getTimezoneOffset() * 60000)
      .toISOString().slice(0,10);
    document.getElementById('date1').value = today;
  });

  // ë¡œë”© ì• ë‹ˆë©”ì´ì…˜
  let loadInterval;
  function showLoading() {
    const overlay = document.getElementById('loadingOverlay');
    const bar = document.getElementById('loadingBar');
    bar.value = 0;
    overlay.style.display = 'block';
    loadInterval = setInterval(function() {
      if (bar.value < 90) bar.value = Math.min(bar.max, bar.value + Math.random() * 10);
    }, 500);
  }
  function hideLoading(message) {
    clearInterval(loadInterval);
    const bar = document.getElementById('loadingBar');
    bar.value = bar.max;
    setTimeout(function() {
      document.getElementById('loadingOverlay').style.display = 'none';
      alert(message);
    }, 300);
  }

  // 1. ìƒì„± ë²„íŠ¼
  document.getElementById('createBtn').addEventListener('click', function() {
    const src = document.getElementById('sourceSheet1').value;
    const tpl = document.getElementById('templateSheet1').value;
    const date = document.getElementById('date1').value.replace(/-/g, '');
    showLoading();
    google.script.run
      .withSuccessHandler(() => hideLoading('âœ… ìƒì„± ì™„ë£Œ!'))
      .withFailureHandler(function(err) {
        clearInterval(loadInterval);
        document.getElementById('loadingOverlay').style.display = 'none';
        alert('ğŸš¨ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
      })
      .createSheetFromTemplateAndSource(tpl, src, date);
  });

  // 2. ë‹¹ì¼ ì‘ì—… í™•ì •
  document.getElementById('moveBtn').addEventListener('click', function() {
    if (!confirm('ì •ë§ í™•ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const name = document.getElementById('moveSheet').value;
    showLoading();
    google.script.run
      .withSuccessHandler(function() {
        hideLoading('âœ… í™•ì • ì™„ë£Œ!');
        google.script.run.withSuccessHandler(pop3).getSheetNames();
      })
      .withFailureHandler(function(err) {
        clearInterval(loadInterval);
        document.getElementById('loadingOverlay').style.display = 'none';
        alert('ğŸš¨ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
      })
      .moveExpectedToTodayByName(name);
  });

  // 3. ì‹œíŠ¸ ë‚´ë³´ë‚´ê¸°
  document.getElementById('exportBtn').addEventListener('click', function() {
    const sheetName1 = document.getElementById('sheet1').value;
    const sheetName2 = document.getElementById('sheet2').value;
    const destId = document.getElementById('destId').value;
    showLoading();
    google.script.run
      .withSuccessHandler(function() {
        hideLoading('âœ… ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!');
      })
      .withFailureHandler(function(err) {
        clearInterval(loadInterval);
        document.getElementById('loadingOverlay').style.display = 'none';
        alert('ğŸš¨ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
      })
      .exportTwoSheetsToSpreadsheet(sheetName1, sheetName2, destId);
  });

  // ì˜µì…˜ ì±„ìš°ê¸° í•¨ìˆ˜ë“¤
  function pop1(names) {
    const src = document.getElementById('sourceSheet1');
    const tpl = document.getElementById('templateSheet1');
    src.innerHTML = '';
    tpl.innerHTML = '';
    names.forEach(n => {
      src.add(new Option(n, n));
      tpl.add(new Option(n, n));
    });
    const defaultSrc = names.find(n => n.startsWith('1.'));
    if (defaultSrc) src.value = defaultSrc;
    const defaultTpl = names.find(n => n.startsWith('ê´€ë¦¬ì'));
    if (defaultTpl) tpl.value = defaultTpl;
  }
  function pop2(names) {
    const mv = document.getElementById('moveSheet');
    mv.innerHTML = '';
    names.forEach(n => mv.add(new Option(n, n)));
    const defaultMove = names.find(n => n.startsWith('1.'));
    if (defaultMove) mv.value = defaultMove;
  }
  function pop3(names) {
    const sel1 = document.getElementById('sheet1');
    const sel2 = document.getElementById('sheet2');
    sel1.innerHTML = '';
    sel2.innerHTML = '';
    const list1 = names.filter(n => n.includes('(ì•ˆì‹¬)'));
    const list2 = names.filter(n => n.includes('(ì‘ì—…)'));
    list1.forEach(n => sel1.add(new Option(n, n)));
    list2.forEach(n => sel2.add(new Option(n, n)));
    if (list1.length) sel1.value = list1[0];
    if (list2.length) sel2.value = list2[0];
  }
  </script>
</body>
</html>
